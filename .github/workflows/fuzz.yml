# ViWoApp Fuzz Testing Pipeline
# Runs Trident fuzz tests for vulnerability discovery
#
# Scheduled to run weekly and on-demand

name: Fuzz Testing

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: "0 2 * * 0"
  workflow_dispatch:
    inputs:
      iterations:
        description: "Number of fuzz iterations"
        required: false
        default: "10000"
      timeout:
        description: "Timeout in seconds"
        required: false
        default: "3600"

env:
  SOLANA_VERSION: "2.0.0"
  ANCHOR_VERSION: "0.32.0"
  RUST_TOOLCHAIN: "1.79.0"

jobs:
  fuzz-staking:
    name: Fuzz Staking Protocol
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
      
      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: VCoinContract/vcoin_workspace
      
      - name: Install Trident
        run: cargo install trident-cli
      
      - name: Run Fuzz Tests
        working-directory: VCoinContract/vcoin_workspace
        timeout-minutes: 60
        run: |
          echo "Running staking protocol fuzz tests..."
          cargo run -p trident-tests --bin fuzz_staking || true
        continue-on-error: true

  fuzz-governance:
    name: Fuzz Governance Protocol
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
      
      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: VCoinContract/vcoin_workspace
      
      - name: Install Trident
        run: cargo install trident-cli
      
      - name: Run Fuzz Tests
        working-directory: VCoinContract/vcoin_workspace
        timeout-minutes: 60
        run: |
          echo "Running governance protocol fuzz tests..."
          cargo run -p trident-tests --bin fuzz_governance || true
        continue-on-error: true

  fuzz-5a:
    name: Fuzz 5A Protocol
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
      
      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: VCoinContract/vcoin_workspace
      
      - name: Install Trident
        run: cargo install trident-cli
      
      - name: Run Fuzz Tests
        working-directory: VCoinContract/vcoin_workspace
        timeout-minutes: 60
        run: |
          echo "Running 5A protocol fuzz tests..."
          cargo run -p trident-tests --bin fuzz_5a || true
        continue-on-error: true

  report:
    name: Generate Fuzz Report
    runs-on: ubuntu-latest
    needs: [fuzz-staking, fuzz-governance, fuzz-5a]
    if: always()
    steps:
      - name: Generate Report
        run: |
          echo "# Fuzz Testing Report" > report.md
          echo "Date: $(date)" >> report.md
          echo "" >> report.md
          echo "## Results" >> report.md
          echo "- Staking: ${{ needs.fuzz-staking.result }}" >> report.md
          echo "- Governance: ${{ needs.fuzz-governance.result }}" >> report.md
          echo "- 5A: ${{ needs.fuzz-5a.result }}" >> report.md
          cat report.md

